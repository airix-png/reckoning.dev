---
title: 'New Features for this Blog'
date: 2019-12-29
tags:
  - Blog
  - Development
  - Javascript
categories:
  - Blog
slug: blog-new-features
template: post
thumbnail: '../thumbnails/new_features.png'
---

2019 has been a year of gatsby updates for this site. So, I wanted to end this year with the same
spirit. And, I am hoping this is going to be the begining of maturity of the looks and features of this
blog. In the upcoming year, I plan to focus mainly on content, specifically related to medicine, AI
and proramming.

Here is a list of all the new features that I have lately added to this:

- updated codeblocks with copy and language indicator
- Medium-like highlight to share text feature
- Simplify navigation bar links
- Update footer to include social links
- Use postlist for similar posts
- Add substack subscription
- Add weekly coding times to code stats page via [wakatime.com](https://wakatime.com/)
- Add [goatcounter](https://www.goatcounter.com/) for analytics
- CSS updates for blokquote, TLDR, Update components etc.
- fix edit on github links

In the following, I want to highlight some of these in little more detail:

### Updated codeblocks component

One of the biggest updates that I made here has been in code blocks. Till now, I have been using
the [gatsby-remark-prismjs](https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-remark-prismjs)
plugin. However, for mdx files, the recommended way is to use the
[prism-react-renderer](https://github.com/FormidableLabs/prism-react-renderer) library, as this
also supports more advanced features like use of live code blocks via
[react-live](https://github.com/FormidableLabs/react-live). This approach additionally provides a
lot of freedom to any user-defined features like copy to clipboard, language indicator etc.

I have followed following gatsby themes to create a `Code` component that can have features like
copy to clipboard, language indicator etc:
[gatsby-theme-minimal-blog](https://www.gatsbyjs.org/packages/@lekoarts/gatsby-theme-minimal-blog/),
and [gatsby-theme-novela](https://github.com/narative/gatsby-theme-novela).

Here is a peek at my final solution:

```js:title=./src/components/Code.js {76-103,152-181}
import { defaultProps } from 'prism-react-renderer';
import loadable from '@loadable/component';
import theme from 'prism-react-renderer/themes/oceanicNext';
import React, { useState } from 'react';
import styled from 'styled-components';
import { copyToClipboard } from '../utils/copyToClipboard';

const LazyHighlight = loadable(async () => {
  const Module = await import(`prism-react-renderer`);
  const Highlight = Module.default;
  const { defaultProps } = Module;
  return props => <Highlight {...defaultProps} {...props} />;
});

const LazyLiveProvider = loadable(async () => {
  const Module = await import(`react-live`);
  const { LiveProvider, LiveEditor, LiveError, LivePreview } = Module;
  return props => (
    <LiveProvider {...props}>
      <LiveEditor data-name='live-editor' />
      <LiveError />
      <LivePreview data-name='live-preview' />
    </LiveProvider>
  );
});

const CopiedIcon = ({ fill = 'white' }) => (
  <svg width='15' height='19' viewBox='0 0 15 15' fill='none' xmlns='http://www.w3.org/2000/svg'>
    <path
      d='M5 3.33333H3.33333V5H5V3.33333ZM5 6.66667H3.33333V8.33333H5V6.66667ZM5 0C4.075 0 3.33333 0.75 3.33333 1.66667H5V0ZM8.33333 10H6.66667V11.6667H8.33333V10ZM13.3333 0V1.66667H15C15 0.75 14.25 0 13.3333 0ZM8.33333 0H6.66667V1.66667H8.33333V0ZM5 11.6667V10H3.33333C3.33333 10.9167 4.075 11.6667 5 11.6667ZM13.3333 8.33333H15V6.66667H13.3333V8.33333ZM13.3333 5H15V3.33333H13.3333V5ZM13.3333 11.6667C14.25 11.6667 15 10.9167 15 10H13.3333V11.6667ZM1.66667 3.33333H0V13.3333C0 14.25 0.741667 15 1.66667 15H11.6667V13.3333H1.66667V3.33333ZM10 1.66667H11.6667V0H10V1.66667ZM10 11.6667H11.6667V10H10V11.6667Z'
      fill={fill}
    />
  </svg>
);

const CopyIcon = ({ fill = '#08080B', ...props }) => (
  <svg
    width='15'
    height='19'
    viewBox='0 0 15 19'
    fill='none'
    xmlns='http://www.w3.org/2000/svg'
    {...props}
  >
    <path
      d='M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z'
      fill={fill}
    />
  </svg>
);

const CopyButton = styled.div`
  position: absolute;
  right: 2px;
  top: 24px;
  padding: 8px 12px 7px;
  border-radius: 0px;
  color: #7c7d80;
  transition: background 0.3s ease;
  &:hover {
    background: rgba(255, 255, 255, 0.07);
  }
  &[data-a11y='true']:focus::after {
    content: '';
    position: absolute;
    left: -2%;
    top: -2%;
    width: 104%;
    height: 104%;
    border: 2px solid #6166dc;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.01);
  }
`;

const Copy = ({ toCopy }) => {
  const [hasCopied, setHasCopied] = useState(false);

  function copyToClipboardOnClick() {
    if (hasCopied) return;

    copyToClipboard(toCopy);
    setHasCopied(true);

    setTimeout(() => {
      setHasCopied(false);
    }, 2000);
  }

  return (
    <CopyButton onClick={copyToClipboardOnClick} data-a11y='false'>
      {hasCopied ? (
        <>
          Copied <CopiedIcon fill='#6f7177' />
        </>
      ) : (
        <>
          Copy <CopyIcon fill='#6f7177' />
        </>
      )}
    </CopyButton>
  );
};

function getParams(className = ``) {
  const [lang = ``, params = ``] = className.split(`:`);

  return [
    // @ts-ignore
    lang
      .split(`language-`)
      .pop()
      .split(`{`)
      .shift()
  ].concat(
    // @ts-ignore
    params.split(`&`).reduce((merged, param) => {
      const [key, value] = param.split(`=`);
      // @ts-ignore
      merged[key] = value;
      return merged;
    }, {})
  );
}

const RE = /{([\d,-]+)}/;

const calculateLinesToHighlight = meta => {
  if (!RE.test(meta)) {
    return () => false;
  }
  const lineNumbers = RE.exec(meta)[1]
    .split(`,`)
    .map(v => v.split(`-`).map(x => parseInt(x, 10)));
  return index => {
    const lineNumber = index + 1;
    const inRange = lineNumbers.some(([start, end]) =>
      end ? lineNumber >= start && lineNumber <= end : lineNumber === start
    );
    return inRange;
  };
};

const Code = ({ codeString, className: blockClassName, metastring = ``, ...props }) => {
  if (props['react-live']) {
    return <LazyLiveProvider code={codeString} noInline={false} theme={theme} />;
  }

  const [language, { title = `` }] = getParams(blockClassName);
  const shouldHighlightLine = calculateLinesToHighlight(metastring);

  return (
    <LazyHighlight {...defaultProps} code={codeString} language={language} theme={theme}>
      {({ className, style, tokens, getLineProps, getTokenProps }) => (
        <React.Fragment>
          {title && (
            <div className='code-title'>
              <div>{title}</div>
            </div>
          )}
          <div className='gatsby-highlight' data-language={language}>
            <pre className={className} style={style}>
              <Copy toCopy={codeString} />
              {tokens.map((line, i) => {
                const lineProps = getLineProps({ line, key: i });
                if (shouldHighlightLine(i)) {
                  lineProps.className = `${lineProps.className} line-highlight`;
                }
                return (
                  <div {...lineProps}>
                    {line.map((token, key) => (
                      <span {...getTokenProps({ token, key })} />
                    ))}
                  </div>
                );
              })}
            </pre>
          </div>
        </React.Fragment>
      )}
    </LazyHighlight>
  );
};

export default Code;
```

Notice, how I have highlighted the filename of the component and the interesting sections of the
code.

The first highlighted section implements the copy to clipboard function. The second section is the
actual implementation of the Code component.

Finally to complete the implementation, two more changes are needed:

- Add `pre` and `code` components to MDXProvider in the post template file, and
- Add relevant css

If you are interested in details of the implementation for your own sites, please take a closer
look at the details of the css at [`./src/styles/components/prism.scss`](https://github.com/sadanand-singh/reckoning.dev/blob/master/src/styles/components/prism.scss).

You can see my [github repository](https://github.com/sadanand-singh/reckoning.dev) for complete
details of the implementation.

Finally, this implementation also supports live coding via the `react-live` library. Here is a
working example:

```js react-live
const Wrapper = ({ children }) => (
  <div
    style={{
      background: 'papayawhip',
      width: '100%',
      padding: '2rem'
    }}
  >
    {children}
  </div>
);

const Title = () => (
  <h2 style={{ color: 'tomato', textAlign: 'center' }}>
    Hello World!
    <br />
    This is reckoning.dev! welcoming you!
  </h2>
);

render(
  <Wrapper>
    <Title />
  </Wrapper>
);
```

### Medium-like highlight to share text

A cool feature in [Medium](https://medium.com/) is the highlight menu that pops up when you select some
text. This menu contains buttons that allow you to perform certain actions on the selected text
like highlight and share.

<ZoomImage
  src='https://res.cloudinary.com/sadanandsingh/image/upload/v1579064368/medium-share_ancyk2.gif'
  alt='cats-dogs'
></ZoomImage>

You can have a look at my [implementation here](https://github.com/sadanand-singh/reckoning.dev/blob/master/src/components/HighlightShare/HighlightShare.js).

And of course, you can see it in action if you try to select and highlight some text. I only
provide options for facebook, twitter and LinkedIn sharing though.

### Add goatcounter for analytics

[goatcounter.com](https://www.goatcounter.com/) is an open source, privacy aware, extremely light
web analytics service that doesn't need a GDPR notice. To me this sounded like a perfect replacement
for google analytics.

The setup is extremely simple - you sign-up and get a script to include on your pages. The problem
that I faced was how to include bare bones Javascript code in a react component.

I ended up using `ScriptTag` from the [react-script-tag](https://www.npmjs.com/package/react-script-tag)
library. This just required me to save the javascript code in a separate file in static folder
and include that using `ScriptTag` in the layout file. You can have a peek at my implementation in
more detail [here](https://github.com/sadanand-singh/reckoning.dev/blob/master/src/layout/index.js).

And of course, you can see my [public dashboard right here](https://reckoningdev.goatcounter.com/).

### Add substack subscription

I have always wanted to provide a timely update about any new posts and updates to my regular
followers. I first tried [mailchimp](https://mailchimp.com/), however, never felt satisfied with it.
Looking for alternatives brought me to [substack](https://substack.com/). I found this to be
a modern solution that fit my needs. Now, you can see a link to my subscription to all pages,
including one right below.

This was all the major changes that I made to the codebase. Other than these major changes, there
are also many small changes to make the code cleaner and more generic.

Here is hoping to bring to an end to any further updates to the looks of this blog. Please look
forward to content updates on major topics like medicine, deep learning and programming. Do not
forget to subscribe to my newsletter below!
